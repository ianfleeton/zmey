<script>
<% tax_total = website.vat_number.empty? ? '' : order.tax_total -%>
ga('require', 'ecommerce');

ga('ecommerce:addTransaction', {
  // Transaction ID. Required.
  'id': '<%= order.order_number %>',
  // Affiliation or store name.
  'affiliation': '<%= website.name %>',
  // Grand Total.
  'revenue': '<%= order.total %>',
  // Shipping.
  'shipping': '<%= order.shipping_amount %>',
  // Tax.
  'tax': '<%= tax_total %>'
});

<%
order.order_lines.each do |line|
  category_or_variation = line.feature_descriptions.present? ? line.feature_descriptions : ''
-%>

  ga('ecommerce:addItem', {
    // Transaction ID. Required.
    'id': '<%= order.order_number %>',
    // Product name. Required.
    'name': '<%= line.product_name.gsub("'", %q(\\\')) %>',
    // SKU/code.
    'sku': '<%= line.product_sku %>',
    // Category or variation.
    'category': '<%= category_or_variation %>',
    // Unit price.
    'price': '<%= line.product_price_inc_tax %>',
    // Quantity.
    'quantity': '<%= line.quantity %>'
  });

<% end -%>

ga('ecommerce:send');
</script>
